
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>详情页面</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Free HTML5 Template by FREEHTML5.CO" />
	<meta name="keywords" content="free html5, free template, free bootstrap, html5, css3, mobile first, responsive" />
	<meta name="author" content="FREEHTML5.CO" />

  <!-- Facebook and Twitter integration -->
	<meta property="og:title" content=""/>
	<meta property="og:image" content=""/>
	<meta property="og:url" content=""/>
	<meta property="og:site_name" content=""/>
	<meta property="og:description" content=""/>
	<meta name="twitter:title" content="" />
	<meta name="twitter:image" content="" />
	<meta name="twitter:url" content="" />
	<meta name="twitter:card" content="" />

	<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
	<link rel="shortcut icon" href="favicon.ico">

	<!-- Google Webfonts -->
	<!--<link href='http://fonts.useso.com/css?family=Roboto:400,300,100,500' rel='stylesheet' type='text/css'>-->
	<!--<link href='http://fonts.useso.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>-->
	
	<!-- Animate.css -->
	<link rel="stylesheet" href="css/animate.css">
	<!-- Icomoon Icon Fonts-->
	<link rel="stylesheet" href="css/icomoon.css">
	<!-- Magnific Popup -->
	<link rel="stylesheet" href="css/magnific-popup.css">
	<!-- Salvattore -->
	<link rel="stylesheet" href="css/salvattore.css">
	<!-- Theme Style -->
	<link rel="stylesheet" href="css/style.css">
	<!-- Modernizr JS -->
	<script src="js/modernizr-2.6.2.min.js"></script>
	<!-- FOR IE9 below -->
	<!--[if lt IE 9]>
	<script src="js/respond.min.js"></script>
	<![endif]-->

	</head>
	<body>
		
	<div id="fh5co-offcanvass">
		<a href="#" class="fh5co-offcanvass-close js-fh5co-offcanvass-close">菜单 <i class="icon-cross"></i> </a>
		<h1 class="fh5co-logo"><a class="navbar-brand" href="detail.html">详情</a></h1>
		<ul>
			<li class="active"><a href="index.html">首页</a></li>
			<li><a href="login.html">登录</a></li>
			<li><a href="register.html">注册</a></li>
			<li><a href="perfect.html">完善信息</a></li>
			<li><a href="upload.html">上传图片</a></li>
		</ul>
	</div>
	<header id="fh5co-header" role="banner">
		<div class="container">
			<div class="row">
				<div class="col-md-12 base-info" style="position: relative;">
					<a href="#" class="fh5co-menu-btn js-fh5co-menu-btn">菜单 <i class="icon-menu"></i></a>
					<a class="navbar-brand" href="index.html">首页</a>
				</div>
			</div>
		</div>
	</header>
	<!-- END .header -->
	
	
	<div id="fh5co-main">
		<div class="container">
			<div class="row">
				<div class="col-md-8 col-md-offset-2">
					<h2 style="float:left;">Personal Bio</h2>
					<div class="delete-btn" style="float:left;"></div>
					<div style="clear:both;" class="fh5co-spacer fh5co-spacer-sm"></div>
					<p>
					<img class="main-img" src="images/img_29_large.jpg" alt="Free HTML5 template by FREEHTML5.co" class="img-rounded img-responsive"></p>

					<p class="content">Far far away, behind the word mountains, far from the countries Vokalia and Consonantia, there live the blind texts. Separated they live in Bookmarksgrove right at the coast of the Semantics, a large language ocean. A small river named Duden flows by their place and supplies it with the necessary regelialia. It is a paradisematic country, in which roasted parts of sentences fly into your mouth. Even the all-powerful Pointing has no control about the blind texts it is an almost unorthographic life One day however a small line of blind text by the name of Lorem Ipsum decided to leave for the far World of Grammar.</p>
				</div>
        	</div>
			<div class="row">
				<div  class="col-md-8 col-md-offset-2">
					<p style="margin-top: 30px;font-size: 22px;font-weight: bold;color:#000;">评论列表：</p>
					<div class="form-group">
						<textarea name="message" id="message" cols="10" class="form-control input-msg" placeholder="评论" rows="4"></textarea>
					</div>
					<div class="form-group">
						<button type="button" class="btn btn-primary subnit-btn">上传评论</button>
					</div>
					<div class="comment-list" style='border-bottom:solid 1px #aaa; margin-bottom:100px;'></div>
				</div>
			</div>
       </div>
	</div>

	<div class="modal fade" id="myModal" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title">提示</h4>
				</div>
				<div class="modal-body">
					<p></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-dismiss="modal" style="margin-bottom:0;">确定</button>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
	<!-- jQuery -->
	<script src="js/jquery.min.js"></script>
	<!-- jQuery Easing -->
	<script src="js/jquery.easing.1.3.js"></script>
	<!-- Bootstrap -->
	<script src="js/bootstrap.min.js"></script>
	<!-- Waypoints -->
	<script src="js/jquery.waypoints.min.js"></script>
	<!-- Magnific Popup -->
	<script src="js/jquery.magnific-popup.min.js"></script>
	<!-- Salvattore -->
	<script src="js/salvattore.min.js"></script>
	<!-- Main JS -->
	<script src="js/main.js"></script>

	<script type="text/javascript">
		var href = location.href;
		var id = href.split("id=")[1];
		var userId =  window.sessionStorage.getItem("userId");
		var userInfo = {};
		if(id.indexOf("#") >= 0){
			id = id.split("#")[0];
		}
		if(!userId){
			location.href = "login.html";
		}

		$.ajax({
			url:"/user/info?id="+userId,
			dataType:"json",
			type:"GET",
			success:function(data){
				userInfo.username = data.body.username;
				var str = '<p class="user-detail" style="position: absolute;right:380px;top:14px;">' +
						'<img style="margin-top:-7px;border: solid 1px #aaa;width:40px;height:40px;margin-right:15px;border-radius:100%;" src="'+data.body.img+'" />' +
						'<span style="font-size: 16px;color:#000;">'+data.body.username+'</span></p>';
				$(".base-info").append(str);
				$(".user-detail").click(function(){
					location.href = "info.html";
				});
			}
		});

		$.ajax({
			url:"/image/detail?id="+id,
			dataType:"json",
			type:"GET",
			success:function(data){
				$(".container h2").html(data.body[0].name);
				$(".main-img").attr("src",data.body[0].img).css("width","100%");
				$(".container .content").html(data.body[0].indroduction);
				if(data.body[0].owner == userId){
					$("#message").hide();
					$(".subnit-btn").hide();
				}
				if(userId == data.body[0].owner){
					var str = '<button style="height:35px;line-height:7px;margin: 17px 0 0 30px;" class="btn btn-default delete-img" type="button">删除图片</button>'
					$(".delete-btn").append(str);
					$(".delete-img").click(function(){
						var param = {
							userId:userId,
							id:id
						};

						$.ajax({
							url:"/image/delete",
							dataType:"json",
							data:JSON.stringify(param),
							type:"POST",
							contentType:"application/json",
							success:function(data){
								if(data.status == 0){
									location.href = "info.html";
								}
							}
						});

					});
				}
			}
		});
		getComment();
		function getComment(){
			$.ajax({
				url:"/image/comment?id="+id,
				dataType:"json",
				type:"GET",
				success:function(data){
					$(".comment-list").empty();
					data.body.reverse();
					var str = "";
					for(var i = 0; i < data.body.length;i++){
						str += "<div style='border-top:solid 1px #aaa;padding:20px;padding-bottom:10px;overflow: hidden;'>" +
								"<div style='float:left;width: 80px;'><img style='width:60px;height:60px;border-radius:100%;border: solid 1px #666;' src='"+data.body[i].userInfo.img+"' /></div>" +
								"<div style='float:left;'><p style='margin-top: 10px;font-size: 17px;font-weight: bold;margin-bottom: 0;'><span>"+data.body[i].userInfo.username+"</span></p>" +
								"<p style='margin-bottom:0;'>"+data.body[i].comment;
						if(data.body[i].userId != userId){
							str += "<a href='javascript:;' index='"+i+"' class='back-text'' style='color:red;margin-left:20px;'>回复</a>"
						}
						str += "</p>";
						if(data.body[i].comments){
							for(var j = 0; j < data.body[i].comments.length; j++){
								str += "<p  style='margin-bottom:0;padding-left: 32px;'><span style='color:#000;font-weight: bold;margin-right:10px;'>"+data.body[i].comments[j].username+"：</span>" +
										"<span>"+data.body[i].comments[j].comment+"</span></p>";
							}
						}
						str += "</div></div>";
					}
					$(".comment-list").append(str);
					$(".back-text").click(function(){
						var index = $(this).attr("index");
						var str = '<div style="position: absolute;width:400px;">' +
								'<div class="form-group">'+
								'<textarea name="message" style="background: #f5f6f7;" id="message-back" cols="10" class="form-control input-msg" placeholder="评论" rows="4"></textarea>'+
								'</div>'+
								'<div class="form-group">'+
								'<button type="button" style="height:35px;line-height:6px;margin-top:-10px;" class="btn btn-primary subnit-btn-back">上传评论</button>'+
								'</div>' +
								'</div>';
						$(this).before(str);
						$(".subnit-btn-back").click(function(){
							var msg = $("#message-back").val();
							if(!msg){
								return false;
							}
							var paramBack = {
								msg:{
									comment:msg,
									username:userInfo.username
								},
								index:index,
								imageId:id
							};
							$.ajax({
								url: "/comment/back",
								dataType: "json",
								type: "POST",
								data:JSON.stringify(paramBack),
								contentType:"application/json",
								success: function (data) {
									if(data.status == 0){
										getComment();
									}
								}
							})
						});
					});
				}
			});
		}

		$(".subnit-btn").click(function(){
			if(!$("#message").val()){
				$(".modal-body p").html("输入框不能为空");
				$('#myModal').modal();
				return false;
			}
			var param = {
				imageId:id,
				userId:window.sessionStorage.getItem("userId"),
				comment:$("#message").val()
			};
			$.ajax({
				url:"/image/comment",
				dataType:"json",
				data:JSON.stringify(param),
				contentType:"application/json",
				type:"POST",
				success:function(data){
					if(data.status == 0){
						console.log("a");
						$("#message").val("");
						getComment();
						$(".modal-body p").html(data.msg);
						$('#myModal').modal();
					}else{
						$(".modal-body p").html(data.msg);
						$('#myModal').modal();
					}
				}
			});
		});
	</script>
	

	
	</body>
</html>
